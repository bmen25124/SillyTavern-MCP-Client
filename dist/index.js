function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,r(o.key),o)}}function r(t){var r=function(t,r){if("object"!=e(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var o=n.call(t,r||"default");if("object"!=e(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}(t,"string");return"symbol"==e(r)?r:r+""}function n(t,r,n){return r=c(r),function(t,r){if(r&&("object"==e(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(t)}(t,a()?Reflect.construct(r,n||[],c(t).constructor):r.apply(t,n))}function o(e){var t="function"==typeof Map?new Map:void 0;return o=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(t){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return function(e,t,r){if(a())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,t);var o=new(e.bind.apply(e,n));return r&&i(o,r.prototype),o}(e,arguments,c(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),i(r,e)},o(e)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(a=function(){return!!e})()}function i(e,t){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},i(e,t)}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}var s=function(){function e(t){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),(r=n(this,e,[t.error])).data=t,r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&i(e,t)}(e,o(Error)),r=e,(a=[{key:"toString",value:function(){return this.data}}])&&t(r.prototype,a),c&&t(r,c),Object.defineProperty(r,"prototype",{writable:!1}),r;var r,a,c}();function u(e){return u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u(e)}function l(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return f(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?f(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){c=!0,a=e},f:function(){try{i||null==r.return||r.return()}finally{if(c)throw a}}}}function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function p(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */p=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",c=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function f(e,t,r,n){var a=t&&t.prototype instanceof b?t:b,i=Object.create(a.prototype),c=new R(n||[]);return o(i,"_invoke",{value:A(e,r,c)}),i}function h(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=f;var d="suspendedStart",v="suspendedYield",y="executing",m="completed",g={};function b(){}function E(){}function x(){}var _={};l(_,i,(function(){return this}));var w=Object.getPrototypeOf,T=w&&w(w(P([])));T&&T!==r&&n.call(T,i)&&(_=T);var S=x.prototype=b.prototype=Object.create(_);function k(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function O(e,t){function r(o,a,i,c){var s=h(e[o],e,a);if("throw"!==s.type){var l=s.arg,f=l.value;return f&&"object"==u(f)&&n.call(f,"__await")?t.resolve(f.__await).then((function(e){r("next",e,i,c)}),(function(e){r("throw",e,i,c)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return r("throw",e,i,c)}))}c(s.arg)}var a;o(this,"_invoke",{value:function(e,n){function o(){return new t((function(t,o){r(e,n,t,o)}))}return a=a?a.then(o,o):o()}})}function A(t,r,n){var o=d;return function(a,i){if(o===y)throw Error("Generator is already running");if(o===m){if("throw"===a)throw i;return{value:e,done:!0}}for(n.method=a,n.arg=i;;){var c=n.delegate;if(c){var s=L(c,n);if(s){if(s===g)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===d)throw o=m,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=y;var u=h(t,r,n);if("normal"===u.type){if(o=n.done?m:v,u.arg===g)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=m,n.method="throw",n.arg=u.arg)}}}function L(t,r){var n=r.method,o=t.iterator[n];if(o===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,L(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),g;var a=h(o,t.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,g;var i=a.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,g):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,g)}function C(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function N(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function R(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(C,this),this.reset(!0)}function P(t){if(t||""===t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function r(){for(;++o<t.length;)if(n.call(t,o))return r.value=t[o],r.done=!1,r;return r.value=e,r.done=!0,r};return a.next=a}}throw new TypeError(u(t)+" is not iterable")}return E.prototype=x,o(S,"constructor",{value:x,configurable:!0}),o(x,"constructor",{value:E,configurable:!0}),E.displayName=l(x,s,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===E||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,l(e,s,"GeneratorFunction")),e.prototype=Object.create(S),e},t.awrap=function(e){return{__await:e}},k(O.prototype),l(O.prototype,c,(function(){return this})),t.AsyncIterator=O,t.async=function(e,r,n,o,a){void 0===a&&(a=Promise);var i=new O(f(e,r,n,o),a);return t.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},k(S),l(S,s,"Generator"),l(S,i,(function(){return this})),l(S,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=P,R.prototype={constructor:R,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(N),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function o(n,o){return c.type="throw",c.arg=t,r.next=n,o&&(r.method="next",r.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],c=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var s=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(s&&u){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(s){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),N(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;N(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:P(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),g}},t}function h(e,t,r,n,o,a,i){try{var c=e[a](i),s=c.value}catch(e){return void r(e)}c.done?t(s):Promise.resolve(s).then(n,o)}function d(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){h(a,n,o,i,c,"next",e)}function c(e){h(a,n,o,i,c,"throw",e)}i(void 0)}))}}function v(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,y(n.key),n)}}function y(e){var t=function(e,t){if("object"!=u(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=u(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==u(t)?t:t+""}var m,g,b,E,x,_,w,T,S,k=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)},O="mcp",A=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)},t=null,r=[{key:"getServers",value:(S=d(p().mark((function e(){var t,r,n;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=SillyTavern.getContext(),e.next=3,fetch("/api/plugins/".concat(O,"/servers"),{method:"GET",headers:t.getRequestHeaders()});case 3:if((r=e.sent).ok){e.next=6;break}return e.abrupt("return",[]);case 6:return e.next=8,r.json();case 8:return n=e.sent,e.abrupt("return",n);case 10:case"end":return e.stop()}}),e)}))),function(){return S.apply(this,arguments)})},{key:"registerTools",value:function(e){var t=k(this,m,"f",b).get(e);if(t){var r,n=t.filter((function(e){return e._enabled})),o=l(n);try{for(o.s();!(r=o.n()).done;){var a=r.value;k(this,m,"m",x).call(this,e,a)}}catch(e){o.e(e)}finally{o.f()}console.log("[MCPClient] Registered ".concat(n.length,' enabled tools for server "').concat(e,'"'))}}},{key:"addServer",value:(T=d(p().mark((function e(t,r){var n,o,a,i,c;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=SillyTavern.getContext(),e.next=3,fetch("/api/plugins/".concat(O,"/servers"),{method:"POST",headers:o.getRequestHeaders(),body:JSON.stringify({name:t,config:r})});case 3:if((a=e.sent).ok){e.next=9;break}return e.next=7,a.json();case 7:throw i=e.sent,new Error(i.error||a.statusText);case 9:if(console.log('[MCPClient] Added server "'.concat(t,'"')),null===(n=o.extensionSettings.mcp)||void 0===n||!n.enabled){e.next=25;break}return console.log('[MCPClient] Auto-starting server "'.concat(t,'"')),e.prev=12,e.next=15,this.connect(t,r);case 15:return e.next=17,k(this,m,"m",E).call(this,t);case 17:this.registerTools(t),e.next=25;break;case 20:throw e.prev=20,e.t0=e.catch(12),(c=new Error('Server "'.concat(t,'" was added but failed to connect: ').concat(e.t0.message))).isConnectError=!0,c;case 25:case"end":return e.stop()}}),e,this,[[12,20]])}))),function(e,t){return T.apply(this,arguments)})},{key:"connect",value:(w=d(p().mark((function e(t,r){var n,o,a;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=SillyTavern.getContext(),e.next=3,fetch("/api/plugins/".concat(O,"/servers/").concat(t,"/start"),{method:"POST",headers:n.getRequestHeaders(),body:JSON.stringify(r)});case 3:if((o=e.sent).ok){e.next=9;break}return e.next=7,o.json();case 7:throw a=e.sent,new Error(a.error||o.statusText);case 9:k(this,m,"f",g).set(t,r),console.log('[MCPClient] Connected to server "'.concat(t,'"'));case 11:case"end":return e.stop()}}),e,this)}))),function(e,t){return w.apply(this,arguments)})},{key:"disconnect",value:(y=d(p().mark((function e(t){var r,n,o;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=SillyTavern.getContext(),e.next=3,fetch("/api/plugins/".concat(O,"/servers/").concat(t,"/stop"),{method:"POST",headers:r.getRequestHeaders()});case 3:if((n=e.sent).ok){e.next=9;break}return e.next=7,n.json();case 7:throw o=e.sent,new Error(o.error||n.statusText);case 9:k(this,m,"f",g).delete(t),console.log('[MCPClient] Disconnected from server "'.concat(t,'"')),k(this,m,"m",_).call(this,t);case 12:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"deleteServer",value:(h=d(p().mark((function e(t){var r,n,o;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=SillyTavern.getContext(),!this.isConnected(t)){e.next=4;break}return e.next=4,this.disconnect(t);case 4:return e.next=6,fetch("/api/plugins/".concat(O,"/servers/").concat(encodeURIComponent(t)),{method:"DELETE",headers:r.getRequestHeaders()});case 6:if((n=e.sent).ok){e.next=12;break}return e.next=10,n.json();case 10:throw o=e.sent,new Error(o.error||n.statusText);case 12:console.log('[MCPClient] Deleted server "'.concat(t,'"'));case 13:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"getConnectedServers",value:function(){return Array.from(k(this,m,"f",g).keys())}},{key:"updateDisabledServers",value:(f=d(p().mark((function e(t){var r,n,o,a,i,c,s,u,f,h,d;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=SillyTavern.getContext(),e.next=3,fetch("/api/plugins/".concat(O,"/servers/disabled"),{method:"POST",headers:r.getRequestHeaders(),body:JSON.stringify({disabledServers:t})});case 3:if((n=e.sent).ok){e.next=9;break}return e.next=7,n.json();case 7:throw o=e.sent,new Error(o.error||n.statusText);case 9:return e.next=11,this.getServers();case 11:a=e.sent,i=l(a),e.prev=13,i.s();case 15:if((c=i.n()).done){e.next=40;break}if(s=c.value,e.prev=17,f=t.includes(s.name),h=this.isConnected(s.name),(d=!f&&(null===(u=r.extensionSettings.mcp)||void 0===u?void 0:u.enabled))||!h){e.next=26;break}return e.next=24,this.disconnect(s.name);case 24:e.next=33;break;case 26:if(!d||h){e.next=33;break}return e.next=29,this.connect(s.name,s.config);case 29:if(k(this,m,"f",b).has(s.name)){e.next=32;break}return e.next=32,k(this,m,"m",E).call(this,s.name);case 32:this.registerTools(s.name);case 33:e.next=38;break;case 35:throw e.prev=35,e.t0=e.catch(17),e.t0;case 38:e.next=15;break;case 40:e.next=45;break;case 42:e.prev=42,e.t1=e.catch(13),i.e(e.t1);case 45:return e.prev=45,i.f(),e.finish(45);case 48:case"end":return e.stop()}}),e,this,[[13,42,45,48],[17,35]])}))),function(e){return f.apply(this,arguments)})},{key:"handleTools",value:(u=d(p().mark((function e(t){var r,n,o,a,i,c,s,u,f,h,d,v,y;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=SillyTavern.getContext(),(null===(r=n.extensionSettings.mcp)||void 0===r?void 0:r.enabled)===t){e.next=3;break}return e.abrupt("return");case 3:if(o=[],!t){e.next=40;break}return e.next=7,this.getServers();case 7:a=e.sent,i=l(a),e.prev=9,i.s();case 11:if((c=i.n()).done){e.next=30;break}if(s=c.value,u=s.name,f=s.config,!s.enabled){e.next=28;break}if(e.prev=15,this.isConnected(u)){e.next=19;break}return e.next=19,this.connect(u,f);case 19:if(k(this,m,"f",b).has(u)){e.next=22;break}return e.next=22,k(this,m,"m",E).call(this,u);case 22:this.registerTools(u),e.next=28;break;case 25:e.prev=25,e.t0=e.catch(15),o.push(e.t0 instanceof Error?e.t0:new Error(String(e.t0)));case 28:e.next=11;break;case 30:e.next=35;break;case 32:e.prev=32,e.t1=e.catch(9),i.e(e.t1);case 35:return e.prev=35,i.f(),e.finish(35);case 38:e.next=64;break;case 40:h=this.getConnectedServers(),d=l(h),e.prev=42,d.s();case 44:if((v=d.n()).done){e.next=56;break}return y=v.value,e.prev=46,e.next=49,this.disconnect(y);case 49:e.next=54;break;case 51:e.prev=51,e.t2=e.catch(46),o.push(e.t2 instanceof Error?e.t2:new Error(String(e.t2)));case 54:e.next=44;break;case 56:e.next=61;break;case 58:e.prev=58,e.t3=e.catch(42),d.e(e.t3);case 61:return e.prev=61,d.f(),e.finish(61);case 64:if(!(o.length>0)){e.next=66;break}throw new Error("Failed to handle some servers: ".concat(o.map((function(e){return e.message})).join(", ")));case 66:case"end":return e.stop()}}),e,this,[[9,32,35,38],[15,25],[42,58,61,64],[46,51]])}))),function(e){return u.apply(this,arguments)})},{key:"isConnected",value:function(e){return k(this,m,"f",g).has(e)}},{key:"getServerTools",value:(c=d(p().mark((function e(t){var r;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=k(this,m,"f",b).get(t))){e.next=3;break}return e.abrupt("return",r);case 3:return e.prev=3,e.next=6,k(this,m,"m",E).call(this,t);case 6:return e.abrupt("return",k(this,m,"f",b).get(t));case 9:return e.prev=9,e.t0=e.catch(3),e.abrupt("return",void 0);case 12:case"end":return e.stop()}}),e,this,[[3,9]])}))),function(e){return c.apply(this,arguments)})},{key:"updateDisabledTools",value:(i=d(p().mark((function e(t,r){var n,o,a,i,c=this;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=SillyTavern.getContext(),e.next=3,fetch("/api/plugins/".concat(O,"/servers/").concat(t,"/disabled-tools"),{method:"POST",headers:n.getRequestHeaders(),body:JSON.stringify({disabledTools:r})});case 3:if((o=e.sent).ok){e.next=9;break}return e.next=7,o.json();case 7:throw a=e.sent,new Error(a.error||o.statusText);case 9:(i=k(this,m,"f",b).get(t))&&i.forEach((function(e){var o,a=e._enabled;if(e._enabled=!r.includes(e.name),null!==(o=n.extensionSettings.mcp)&&void 0!==o&&o.enabled&&c.isConnected(t)){var i="mcp_".concat(t,"_").concat(e.name);a&&!e._enabled?n.unregisterFunctionTool(i):!a&&e._enabled&&k(c,m,"m",x).call(c,t,e)}}));case 11:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"callTool",value:(a=d(p().mark((function e(t,r,n){var o,a,i,c;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=SillyTavern.getContext(),this.isConnected(t)){e.next=3;break}throw new Error('MCP server "'.concat(t,'" is not connected.'));case 3:return e.next=5,fetch("/api/plugins/".concat(O,"/servers/").concat(t,"/call-tool"),{method:"POST",body:JSON.stringify({toolName:r,arguments:n}),headers:o.getRequestHeaders()});case 5:if((a=e.sent).ok){e.next=11;break}return e.next=9,a.json();case 9:throw i=e.sent,new s(i.data||i.error||a.statusText);case 11:return e.next=13,a.json();case 13:return c=e.sent,console.log('[MCPClient] Successfully called tool "'.concat(r,'" on server "').concat(t,'":'),c.result),e.abrupt("return",c.result);case 16:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return a.apply(this,arguments)})},{key:"reloadAllTools",value:(o=d(p().mark((function e(){var t,r,n,o,a,i,c,s,u;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=SillyTavern.getContext(),e.next=3,this.getServers();case 3:r=e.sent,n=[],o=l(r),e.prev=6,o.s();case 8:if((a=o.n()).done){e.next=31;break}return i=a.value,c=i.name,e.prev=11,e.next=14,fetch("/api/plugins/".concat(O,"/servers/").concat(c,"/reload-tools"),{method:"POST",headers:t.getRequestHeaders()});case 14:if((s=e.sent).ok){e.next=20;break}return e.next=18,s.json();case 18:throw u=e.sent,new Error(u.error||s.statusText);case 20:return e.next=22,k(this,m,"m",E).call(this,c);case 22:this.registerTools(c),console.log('[MCPClient] Successfully reloaded tools for server "'.concat(c,'"')),e.next=29;break;case 26:e.prev=26,e.t0=e.catch(11),n.push(e.t0 instanceof Error?e.t0:new Error(String(e.t0)));case 29:e.next=8;break;case 31:e.next=36;break;case 33:e.prev=33,e.t1=e.catch(6),o.e(e.t1);case 36:return e.prev=36,o.f(),e.finish(36);case 39:if(!(n.length>0)){e.next=41;break}throw new Error("Failed to reload tools for some servers: ".concat(n.map((function(e){return e.message})).join(", ")));case 41:case"end":return e.stop()}}),e,this,[[6,33,36,39],[11,26]])}))),function(){return o.apply(this,arguments)})},{key:"openServerSettings",value:(n=d(p().mark((function e(){var t,r,n;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=SillyTavern.getContext(),e.next=3,fetch("/api/plugins/".concat(O,"/open-settings"),{method:"POST",headers:t.getRequestHeaders()});case 3:if((r=e.sent).ok){e.next=9;break}return e.next=7,r.json();case 7:throw n=e.sent,new Error(n.error||r.statusText);case 9:case"end":return e.stop()}}),e)}))),function(){return n.apply(this,arguments)})}],t&&v(e.prototype,t),r&&v(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,r,n,o,a,i,c,u,f,h,y,w,T,S}();function L(e){return L="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},L(e)}function C(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */C=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",c=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof m?t:m,i=Object.create(a.prototype),c=new R(n||[]);return o(i,"_invoke",{value:k(e,r,c)}),i}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=l;var p="suspendedStart",h="suspendedYield",d="executing",v="completed",y={};function m(){}function g(){}function b(){}var E={};u(E,i,(function(){return this}));var x=Object.getPrototypeOf,_=x&&x(x(P([])));_&&_!==r&&n.call(_,i)&&(E=_);var w=b.prototype=m.prototype=Object.create(E);function T(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function S(e,t){function r(o,a,i,c){var s=f(e[o],e,a);if("throw"!==s.type){var u=s.arg,l=u.value;return l&&"object"==L(l)&&n.call(l,"__await")?t.resolve(l.__await).then((function(e){r("next",e,i,c)}),(function(e){r("throw",e,i,c)})):t.resolve(l).then((function(e){u.value=e,i(u)}),(function(e){return r("throw",e,i,c)}))}c(s.arg)}var a;o(this,"_invoke",{value:function(e,n){function o(){return new t((function(t,o){r(e,n,t,o)}))}return a=a?a.then(o,o):o()}})}function k(t,r,n){var o=p;return function(a,i){if(o===d)throw Error("Generator is already running");if(o===v){if("throw"===a)throw i;return{value:e,done:!0}}for(n.method=a,n.arg=i;;){var c=n.delegate;if(c){var s=O(c,n);if(s){if(s===y)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===p)throw o=v,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=d;var u=f(t,r,n);if("normal"===u.type){if(o=n.done?v:h,u.arg===y)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=v,n.method="throw",n.arg=u.arg)}}}function O(t,r){var n=r.method,o=t.iterator[n];if(o===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,O(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),y;var a=f(o,t.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,y;var i=a.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,y):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function A(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function N(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function R(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(A,this),this.reset(!0)}function P(t){if(t||""===t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function r(){for(;++o<t.length;)if(n.call(t,o))return r.value=t[o],r.done=!1,r;return r.value=e,r.done=!0,r};return a.next=a}}throw new TypeError(L(t)+" is not iterable")}return g.prototype=b,o(w,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,s,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,u(e,s,"GeneratorFunction")),e.prototype=Object.create(w),e},t.awrap=function(e){return{__await:e}},T(S.prototype),u(S.prototype,c,(function(){return this})),t.AsyncIterator=S,t.async=function(e,r,n,o,a){void 0===a&&(a=Promise);var i=new S(l(e,r,n,o),a);return t.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},T(w),u(w,s,"Generator"),u(w,i,(function(){return this})),u(w,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=P,R.prototype={constructor:R,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(N),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function o(n,o){return c.type="throw",c.arg=t,r.next=n,o&&(r.method="next",r.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],c=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var s=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(s&&u){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(s){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,y):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),N(r),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;N(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:P(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),y}},t}function N(e,t,r,n,o,a,i){try{var c=e[a](i),s=c.value}catch(e){return void r(e)}c.done?t(s):Promise.resolve(s).then(n,o)}function R(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){N(a,n,o,i,c,"next",e)}function c(e){N(a,n,o,i,c,"throw",e)}i(void 0)}))}}m=A,E=function(){var e=d(p().mark((function e(t){var r,n,o,a,i;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=SillyTavern.getContext(),e.next=3,fetch("/api/plugins/".concat(O,"/servers/").concat(t,"/list-tools"),{method:"GET",headers:r.getRequestHeaders()});case 3:if((n=e.sent).ok){e.next=9;break}return e.next=7,n.json();case 7:throw o=e.sent,new Error(o.error||n.statusText);case 9:return e.next=11,n.json();case 11:a=e.sent,i=Array.isArray(a)?a:[],k(this,m,"f",b).set(t,i);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),x=function(e,t){var r,n,o=this,a=SillyTavern.getContext(),i="mcp_".concat(e,"_").concat(t.name);a.registerFunctionTool({name:i,displayName:"".concat(e,": ").concat(t.name),description:t.description||'Tool from MCP server "'.concat(e,'"'),parameters:t.inputSchema||{type:"object",properties:{}},action:(n=d(p().mark((function r(n){return p().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,o.callTool(e,t.name,n);case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),r)}))),function(e){return n.apply(this,arguments)}),formatMessage:(r=d(p().mark((function r(n){return p().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",'Calling MCP tool "'.concat(t.name,'" on server "').concat(e,'"'));case 1:case"end":return r.stop()}}),r)}))),function(e){return r.apply(this,arguments)})})},_=function(e){var t,r=SillyTavern.getContext(),n=l(k(this,m,"f",b).get(e)||[]);try{for(n.s();!(t=n.n()).done;){var o=t.value,a="mcp_".concat(e,"_").concat(o.name);r.unregisterFunctionTool(a)}}catch(e){n.e(e)}finally{n.f()}k(this,m,"f",b).delete(e),console.log('[MCPClient] Unregistered all tools for server "'.concat(e,'"'))},g={value:new Map},b={value:new Map},function(e){e.APP_READY="app_ready",e.EXTRAS_CONNECTED="extras_connected",e.MESSAGE_SWIPED="message_swiped",e.MESSAGE_SENT="message_sent",e.MESSAGE_RECEIVED="message_received",e.MESSAGE_EDITED="message_edited",e.MESSAGE_DELETED="message_deleted",e.MESSAGE_UPDATED="message_updated",e.MESSAGE_FILE_EMBEDDED="message_file_embedded",e.MORE_MESSAGES_LOADED="more_messages_loaded",e.IMPERSONATE_READY="impersonate_ready",e.CHAT_CHANGED="chat_id_changed",e.GENERATION_AFTER_COMMANDS="GENERATION_AFTER_COMMANDS",e.GENERATION_STARTED="generation_started",e.GENERATION_STOPPED="generation_stopped",e.GENERATION_ENDED="generation_ended",e.EXTENSIONS_FIRST_LOAD="extensions_first_load",e.EXTENSION_SETTINGS_LOADED="extension_settings_loaded",e.SETTINGS_LOADED="settings_loaded",e.SETTINGS_UPDATED="settings_updated",e.GROUP_UPDATED="group_updated",e.MOVABLE_PANELS_RESET="movable_panels_reset",e.SETTINGS_LOADED_BEFORE="settings_loaded_before",e.SETTINGS_LOADED_AFTER="settings_loaded_after",e.CHATCOMPLETION_SOURCE_CHANGED="chatcompletion_source_changed",e.CHATCOMPLETION_MODEL_CHANGED="chatcompletion_model_changed",e.OAI_PRESET_CHANGED_BEFORE="oai_preset_changed_before",e.OAI_PRESET_CHANGED_AFTER="oai_preset_changed_after",e.OAI_PRESET_EXPORT_READY="oai_preset_export_ready",e.OAI_PRESET_IMPORT_READY="oai_preset_import_ready",e.WORLDINFO_SETTINGS_UPDATED="worldinfo_settings_updated",e.WORLDINFO_UPDATED="worldinfo_updated",e.CHARACTER_EDITED="character_edited",e.CHARACTER_PAGE_LOADED="character_page_loaded",e.CHARACTER_GROUP_OVERLAY_STATE_CHANGE_BEFORE="character_group_overlay_state_change_before",e.CHARACTER_GROUP_OVERLAY_STATE_CHANGE_AFTER="character_group_overlay_state_change_after",e.USER_MESSAGE_RENDERED="user_message_rendered",e.CHARACTER_MESSAGE_RENDERED="character_message_rendered",e.FORCE_SET_BACKGROUND="force_set_background",e.CHAT_DELETED="chat_deleted",e.CHAT_CREATED="chat_created",e.GROUP_CHAT_DELETED="group_chat_deleted",e.GROUP_CHAT_CREATED="group_chat_created",e.GENERATE_BEFORE_COMBINE_PROMPTS="generate_before_combine_prompts",e.GENERATE_AFTER_COMBINE_PROMPTS="generate_after_combine_prompts",e.GENERATE_AFTER_DATA="generate_after_data",e.GROUP_MEMBER_DRAFTED="group_member_drafted",e.WORLD_INFO_ACTIVATED="world_info_activated",e.TEXT_COMPLETION_SETTINGS_READY="text_completion_settings_ready",e.CHAT_COMPLETION_SETTINGS_READY="chat_completion_settings_ready",e.CHAT_COMPLETION_PROMPT_READY="chat_completion_prompt_ready",e.CHARACTER_FIRST_MESSAGE_SELECTED="character_first_message_selected",e.CHARACTER_DELETED="characterDeleted",e.CHARACTER_DUPLICATED="character_duplicated",e.CHARACTER_RENAMED="character_renamed",e.SMOOTH_STREAM_TOKEN_RECEIVED="stream_token_received",e.STREAM_TOKEN_RECEIVED="stream_token_received",e.STREAM_REASONING_DONE="stream_reasoning_done",e.FILE_ATTACHMENT_DELETED="file_attachment_deleted",e.WORLDINFO_FORCE_ACTIVATE="worldinfo_force_activate",e.OPEN_CHARACTER_LIBRARY="open_character_library",e.ONLINE_STATUS_CHANGED="online_status_changed",e.IMAGE_SWIPED="image_swiped",e.CONNECTION_PROFILE_LOADED="connection_profile_loaded",e.TOOL_CALLS_PERFORMED="tool_calls_performed",e.TOOL_CALLS_RENDERED="tool_calls_rendered"}(w||(w={})),function(e){e[e.TEXT=1]="TEXT",e[e.CONFIRM=2]="CONFIRM",e[e.INPUT=3]="INPUT",e[e.DISPLAY=4]="DISPLAY"}(T||(T={})),function(e){e[e.AFFIRMATIVE=1]="AFFIRMATIVE",e[e.NEGATIVE=0]="NEGATIVE",e[e.CANCELLED=null]="CANCELLED"}(S||(S={}));SillyTavern.getContext();function P(e,t){return D.apply(this,arguments)}function D(){return(D=R(C().mark((function e(t,r){return C().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,SillyTavern.getContext().SlashCommandParser.commands.echo.callback({severity:t},r);case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function M(){return j.apply(this,arguments)}function j(){return(j=R(C().mark((function e(){return C().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,SillyTavern.getContext().SlashCommandParser.commands.trigger.callback();case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function I(e){return I="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},I(e)}function G(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return H(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?H(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){c=!0,a=e},f:function(){try{i||null==r.return||r.return()}finally{if(c)throw a}}}}function H(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function F(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function U(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?F(Object(r),!0).forEach((function(t){q(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):F(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function q(e,t,r){return(t=function(e){var t=function(e,t){if("object"!=I(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=I(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==I(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Y(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */Y=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",c=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof m?t:m,i=Object.create(a.prototype),c=new C(n||[]);return o(i,"_invoke",{value:k(e,r,c)}),i}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=l;var p="suspendedStart",h="suspendedYield",d="executing",v="completed",y={};function m(){}function g(){}function b(){}var E={};u(E,i,(function(){return this}));var x=Object.getPrototypeOf,_=x&&x(x(N([])));_&&_!==r&&n.call(_,i)&&(E=_);var w=b.prototype=m.prototype=Object.create(E);function T(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function S(e,t){function r(o,a,i,c){var s=f(e[o],e,a);if("throw"!==s.type){var u=s.arg,l=u.value;return l&&"object"==I(l)&&n.call(l,"__await")?t.resolve(l.__await).then((function(e){r("next",e,i,c)}),(function(e){r("throw",e,i,c)})):t.resolve(l).then((function(e){u.value=e,i(u)}),(function(e){return r("throw",e,i,c)}))}c(s.arg)}var a;o(this,"_invoke",{value:function(e,n){function o(){return new t((function(t,o){r(e,n,t,o)}))}return a=a?a.then(o,o):o()}})}function k(t,r,n){var o=p;return function(a,i){if(o===d)throw Error("Generator is already running");if(o===v){if("throw"===a)throw i;return{value:e,done:!0}}for(n.method=a,n.arg=i;;){var c=n.delegate;if(c){var s=O(c,n);if(s){if(s===y)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===p)throw o=v,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=d;var u=f(t,r,n);if("normal"===u.type){if(o=n.done?v:h,u.arg===y)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=v,n.method="throw",n.arg=u.arg)}}}function O(t,r){var n=r.method,o=t.iterator[n];if(o===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,O(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),y;var a=f(o,t.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,y;var i=a.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,y):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function A(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function L(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function C(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(A,this),this.reset(!0)}function N(t){if(t||""===t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function r(){for(;++o<t.length;)if(n.call(t,o))return r.value=t[o],r.done=!1,r;return r.value=e,r.done=!0,r};return a.next=a}}throw new TypeError(I(t)+" is not iterable")}return g.prototype=b,o(w,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,s,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,u(e,s,"GeneratorFunction")),e.prototype=Object.create(w),e},t.awrap=function(e){return{__await:e}},T(S.prototype),u(S.prototype,c,(function(){return this})),t.AsyncIterator=S,t.async=function(e,r,n,o,a){void 0===a&&(a=Promise);var i=new S(l(e,r,n,o),a);return t.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},T(w),u(w,s,"Generator"),u(w,i,(function(){return this})),u(w,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=N,C.prototype={constructor:C,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(L),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function o(n,o){return c.type="throw",c.arg=t,r.next=n,o&&(r.method="next",r.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],c=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var s=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(s&&u){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(s){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,y):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),L(r),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;L(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:N(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),y}},t}function V(e,t,r,n,o,a,i){try{var c=e[a](i),s=c.value}catch(e){return void r(e)}c.done?t(s):Promise.resolve(s).then(n,o)}function B(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){V(a,n,o,i,c,"next",e)}function c(e){V(a,n,o,i,c,"throw",e)}i(void 0)}))}}var J="SillyTavern-MCP-Client",W={enabled:!1},X=SillyTavern.getContext();function K(){return K=B(Y().mark((function e(){var t,r,n,o,a,i;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=function(){return i=B(Y().mark((function e(r){var n,o,i,c,s,u,l;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.querySelector("#mcp-tools-list"),o=r.querySelector("#server-section-template"),n.innerHTML="",e.next=5,A.getServers();case 5:if(0!==(i=e.sent).length){e.next=13;break}(c=document.createElement("div")).className="no-servers",c.textContent="No MCP servers found.",n.appendChild(c),e.next=29;break;case 13:s=G(i),e.prev=14,l=Y().mark((function e(){var i,c,s,l,f,p,h,d;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=u.value,c=A.isConnected(i.name),s=o.content.cloneNode(!0),l=s.querySelector(".server-tools-section"),c||l.classList.add("disabled"),l.querySelector("h4").textContent=i.name,(f=l.querySelector(".server-toggle")).checked=c,f.dataset.server=i.name,(p=l.querySelector(".server-header")).addEventListener("click",(function(e){if(!e.target.closest(".checkbox_label")){var t=l.querySelector(".tools-list"),r=p.querySelector("i");t.classList.toggle("collapsed"),r.style.transform=t.classList.contains("collapsed")?"rotate(-90deg)":""}})),f.addEventListener("change",B(Y().mark((function e(){var t,n,o,a,c,s;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=f.closest(".server-tools-section"),n=f.closest(".checkbox_label"),o=n.querySelector("span"),a=o.textContent,f.disabled=!0,o.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Updating...',c=f.checked,e.prev=7,t.classList.toggle("disabled",!c),s=Array.from(r.querySelectorAll(".server-toggle")).filter((function(e){return!e.checked})).map((function(e){return e.dataset.server})),e.next=12,A.updateDisabledServers(s);case 12:return o.innerHTML='<i class="fa-solid fa-check"></i> Updated',e.next=15,Z();case 15:e.next=25;break;case 17:return e.prev=17,e.t0=e.catch(7),console.error("Error updating server state:",e.t0),o.innerHTML='<i class="fa-solid fa-exclamation-triangle"></i> Failed',f.checked=!f.checked,t.classList.toggle("disabled",!f.checked),e.next=25,P("error","Failed to ".concat(c?"enable":"disable",' server "').concat(i.name,'"'));case 25:setTimeout((function(){o.textContent=a,f.disabled=!1}),1500);case 26:case"end":return e.stop()}}),e,null,[[7,17]])})))),l.querySelector(".delete-server").addEventListener("click",function(){var e=B(Y().mark((function e(n){var o;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.stopPropagation(),o=i.name,e.next=4,t.Popup.show.confirm("Are you sure you want to delete the selected server?",o);case 4:if(!e.sent){e.next=19;break}return e.prev=6,e.next=9,A.deleteServer(o);case 9:return console.log('Server "'.concat(o,'" removed successfully')),e.next=12,a(r);case 12:e.next=19;break;case 14:return e.prev=14,e.t0=e.catch(6),console.error("Error removing server:",e.t0),e.next=19,P("error",'Error removing server "'.concat(o,'"'));case 19:case"end":return e.stop()}}),e,null,[[6,14]])})));return function(t){return e.apply(this,arguments)}}()),e.next=16,A.getServerTools(i.name);case 16:(h=e.sent)&&h.length>0&&(d=l.querySelector(".tools-list"),h.forEach((function(e){var t=document.createElement("div");t.className="tool-item",t.innerHTML='\n              <div class="tool-header">\n                <span class="tool-name">'.concat(e.name,'</span>\n                <label class="checkbox_label">\n                  <input type="checkbox" class="tool-toggle" ').concat(e._enabled?"checked":"",' />\n                  <span>Enable</span>\n                </label>\n              </div>\n              <div class="tool-description">').concat(e.description||"No description available","</div>\n            ");var r=t.querySelector(".tool-toggle");r.dataset.server=i.name,r.dataset.tool=e.name,d.appendChild(t)}))),n.appendChild(l);case 19:case"end":return e.stop()}}),e)})),s.s();case 17:if((u=s.n()).done){e.next=21;break}return e.delegateYield(l(),"t0",19);case 19:e.next=17;break;case 21:e.next=26;break;case 23:e.prev=23,e.t1=e.catch(14),s.e(e.t1);case 26:return e.prev=26,s.f(),e.finish(26);case 29:case"end":return e.stop()}}),e,null,[[14,23,26,29]])}))),i.apply(this,arguments)},a=function(e){return i.apply(this,arguments)},o=function(){return(o=B(Y().mark((function e(r){var n,o,a;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.renderExtensionTemplateAsync("third-party/".concat(J),r);case 2:return n=e.sent,(o=document.createElement("div")).innerHTML=n,a=o.firstElementChild,t.callGenericPopup($(a),T.DISPLAY),e.abrupt("return",a);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)},n=function(e){return o.apply(this,arguments)},t=SillyTavern.getContext(),e.next=7,t.renderExtensionTemplateAsync("third-party/".concat(J),"templates/settings");case 7:return r=e.sent,$("#extensions_settings").append(r),$("#mcp_enabled").prop("checked",t.extensionSettings.mcp.enabled).on("change",B(Y().mark((function e(){var r,n,o,a,i;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=$(this),n=r.parent(".checkbox_label"),o=n.find("span"),a=o.text(),r.prop("disabled",!0),o.html('<i class="fa-solid fa-spinner fa-spin"></i> Updating...'),i=r.prop("checked"),t.extensionSettings.mcp.enabled=i,t.saveSettingsDebounced(),e.prev=9,e.next=12,A.handleTools(i);case 12:return o.html('<i class="fa-solid fa-check"></i> Updated'),e.next=15,Z(!i);case 15:e.next=22;break;case 17:e.prev=17,e.t0=e.catch(9),console.error("[MCPClient] Error handling MCP tools:",e.t0),o.html('<i class="fa-solid fa-exclamation-triangle"></i> Failed'),P("error","[MCPClient] Error handling MCP tools: ".concat(e.t0));case 22:setTimeout((function(){o.text(a),r.prop("disabled",!1)}),1500);case 23:case"end":return e.stop()}}),e,this,[[9,17]])})))),$("#mcp_manage_tools").on("click",B(Y().mark((function e(){var t,r,o,i,c,s,u,l;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n("templates/tools");case 2:return c=e.sent,e.next=5,a(c);case 5:s=c.querySelector("#add-server"),u=c.querySelector("#submit-server"),l=$("#server-input"),s.disabled=!1,l.on("input",(function(){u.disabled=!l.val()})),s.addEventListener("click",(function(){$("#add-server-form").show(),s.disabled=!0})),null===(t=c.querySelector("#cancel-server"))||void 0===t||t.addEventListener("click",(function(){$("#add-server-form").hide(),l.val(""),s.disabled=!1,u.disabled=!0})),null===(r=c.querySelector("#submit-server"))||void 0===r||r.addEventListener("click",B(Y().mark((function e(){var t,r,n,o,i,u,f,p,h,d;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=c.querySelector("#submit-server"),r=$("#server-input").val()){e.next=4;break}return e.abrupt("return");case 4:if(n=t.innerHTML,t.disabled=!0,t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Adding...',o="",e.prev=8,!r.trim().startsWith("{")){e.next=21;break}if((u=JSON.parse(r)).mcpServers){e.next=13;break}throw new Error("Invalid config: missing mcpServers object");case 13:if(f=Object.entries(u.mcpServers)[0]){e.next=16;break}throw new Error("Invalid config: no server configuration found");case 16:o=f[0],p=f[1],i=U(U({},p),{},{type:"stdio"}),e.next=25;break;case 21:h=r.trim().split(" "),d=h[h.length-1],o=d.split("/").pop(),i={command:h[0],args:h.slice(1),env:{},type:"stdio"};case 25:return e.next=27,A.addServer(o,i);case 27:return console.log('Server "'.concat(o,'" added successfully')),e.next=30,P("success",'Server "'.concat(o,'" added successfully'));case 30:return t.innerHTML='<i class="fa-solid fa-check"></i> Success',t.style.background="var(--active)",$("#add-server-form").hide(),$("#server-input").val(""),e.next=36,a(c);case 36:return e.next=38,Z();case 38:e.next=58;break;case 40:if(e.prev=40,e.t0=e.catch(8),console.error("Error adding server:",e.t0),!e.t0.isConnectError){e.next=54;break}return e.next=46,P("warning",e.t0.message);case 46:return t.innerHTML='<i class="fa-solid fa-exclamation-triangle"></i> Added With Warning',t.style.background="var(--warning)",$("#add-server-form").hide(),$("#server-input").val(""),e.next=52,a(c);case 52:e.next=58;break;case 54:return e.next=56,P("error","Error adding server: ".concat(e.t0.message));case 56:t.innerHTML='<i class="fa-solid fa-exclamation-triangle"></i> Error',t.style.background="var(--error)";case 58:setTimeout((function(){t.innerHTML=n,t.style.background="",t.disabled=!l.val(),s.disabled=!1}),1500);case 59:case"end":return e.stop()}}),e,null,[[8,40]])})))),null===(o=c.querySelector("#reload-all-tools"))||void 0===o||o.addEventListener("click",function(){var e=B(Y().mark((function e(t){var r,n;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.currentTarget,n=r.innerHTML,r.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Refreshing',r.disabled=!0,e.prev=4,e.next=7,A.reloadAllTools();case 7:return r.innerHTML='<i class="fa-solid fa-check"></i> Success',r.style.background="var(--active)",console.log("Successfully reloaded all tools"),e.next=12,P("success","Successfully reloaded all tools");case 12:return e.next=14,a(c);case 14:return e.next=16,Z();case 16:setTimeout((function(){r.innerHTML=n,r.style.background="",r.disabled=!1}),1500),e.next=27;break;case 19:return e.prev=19,e.t0=e.catch(4),console.error("Error reloading tools:",e.t0),r.innerHTML='<i class="fa-solid fa-exclamation-triangle"></i> Error',r.style.background="var(--warning)",e.next=26,P("error","Error reloading tools");case 26:setTimeout((function(){r.innerHTML=n,r.style.background="",r.disabled=!1}),1500);case 27:case"end":return e.stop()}}),e,null,[[4,19]])})));return function(t){return e.apply(this,arguments)}}()),null===(i=c.querySelector("#open-server-settings"))||void 0===i||i.addEventListener("click",function(){var e=B(Y().mark((function e(t){var r,n;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.currentTarget,n=r.innerHTML,r.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Opening',r.disabled=!0,e.prev=4,e.next=7,A.openServerSettings();case 7:r.innerHTML='<i class="fa-solid fa-check"></i> Success',r.style.background="var(--active)",e.next=18;break;case 11:return e.prev=11,e.t0=e.catch(4),console.error("Error opening settings:",e.t0),r.innerHTML='<i class="fa-solid fa-exclamation-triangle"></i> Error',r.style.background="var(--warning)",e.next=18,P("error","Error opening settings");case 18:setTimeout((function(){r.innerHTML=n,r.style.background="",r.disabled=!1}),1500);case 19:case"end":return e.stop()}}),e,null,[[4,11]])})));return function(t){return e.apply(this,arguments)}}()),c.addEventListener("change",function(){var e=B(Y().mark((function e(t){var r,n,o,a,i,s,u;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.target).classList.contains("tool-toggle")){e.next=3;break}return e.abrupt("return");case 3:return n=r.closest(".checkbox_label"),o=n.querySelector("span"),a=o.textContent,r.disabled=!0,o.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Updating...',e.prev=8,i=r.dataset.server,e.next=12,A.getServerTools(i);case 12:if(s=e.sent){e.next=15;break}throw new Error("Could not get server tools");case 15:return u=s.filter((function(e){return!c.querySelector('input.tool-toggle[data-server="'.concat(i,'"][data-tool="').concat(e.name,'"]')).checked})).map((function(e){return e.name})),e.next=18,A.updateDisabledTools(i,u);case 18:return o.innerHTML='<i class="fa-solid fa-check"></i> Updated',e.next=21,Z();case 21:e.next=30;break;case 23:return e.prev=23,e.t0=e.catch(8),console.error("Error updating tool state:",e.t0),o.innerHTML='<i class="fa-solid fa-exclamation-triangle"></i> Failed',r.checked=!r.checked,e.next=30,P("error","Failed to update tool state");case 30:setTimeout((function(){o.textContent=a,r.disabled=!1}),1500);case 31:case"end":return e.stop()}}),e,null,[[8,23]])})));return function(t){return e.apply(this,arguments)}}());case 16:case"end":return e.stop()}}),e)})))),e.prev=11,e.next=14,A.handleTools(t.extensionSettings.mcp.enabled);case 14:e.next=20;break;case 16:return e.prev=16,e.t0=e.catch(11),e.next=20,P("error","Error handling tools: ".concat(e.t0.message));case 20:case"end":return e.stop()}}),e,null,[[11,16]])}))),K.apply(this,arguments)}function z(){return z=B(Y().mark((function e(){var t,r;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=function(){return(r=B(Y().mark((function e(t){var r,n,o;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.tools){e.next=2;break}return e.abrupt("return");case 2:r=t.chat_completion_source,n=function(e){"object"===I(e)&&null!==e&&(e.title&&delete e.title,e.properties&&Object.values(e.properties).forEach((function(e){return n(e)})),e.items&&n(e.items),["allOf","anyOf","oneOf"].forEach((function(t){Array.isArray(e[t])&&e[t].forEach((function(e){return n(e)}))})))},t.tools.forEach((function(e){n(e.function.parameters)})),o=function(e){"object"===I(e)&&null!==e&&(delete e.additionalProperties,delete e.default,e.properties&&("object"===e.type&&0===Object.keys(e.properties).length&&(e.properties={_dummy:{type:"string",description:"This is a placeholder property to satisfy MakerSuite requirements."}}),Object.values(e.properties).forEach((function(e){return o(e)}))),e.items&&o(e.items),["allOf","anyOf","oneOf"].forEach((function(t){Array.isArray(e[t])&&e[t].forEach((function(e){return o(e)}))})))},"makersuite"===r&&t.tools.forEach((function(e){o(e.function.parameters)}));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)},t=function(e){return r.apply(this,arguments)},X.eventSource.on(w.CHAT_COMPLETION_SETTINGS_READY,function(){var e=B(Y().mark((function e(r){return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t(r);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 3:case"end":return e.stop()}}),e)}))),z.apply(this,arguments)}var Q="SillyTavern-MCP-Client-Tools-Instruct";function Z(){return ee.apply(this,arguments)}function ee(){return ee=B(Y().mark((function e(){var t,r,n,o,a=arguments;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=a.length>0&&void 0!==a[0]&&a[0],r=SillyTavern.getContext(),!t&&"textgenerationwebui"===r.mainApi){e.next=5;break}return delete r.extensionPrompts[Q],e.abrupt("return");case 5:return n={},e.next=8,r.registerFunctionToolsOpenAI(n);case 8:if(n.tools){e.next=10;break}return e.abrupt("return");case 10:o='\x3c!-- Start of Tool Usage Guidelines --\x3e\n\n### Tool Invocation\n-  You have two distinct modes of response: **Tool Invocation Mode** and **Roleplay Mode**.\n-  You **MUST** choose **ONE** of these modes for each response.  **NEVER** combine them.\n\n### Tool Invocation Mode\n\n-  You should enter **Tool Invocation Mode** only when you deem it absolutely necessary to use one or more tools to enhance the roleplay, and when those tools can provide information or perform actions that are critical to the story\'s progress.\n-  In **Tool Invocation Mode**, your **ENTIRE** response MUST consist *only* of a properly formatted JSON array of tool invocation details (see details below). Do **NOT** include any other text, narration, dialogue, or explanations.\n-  You should only use multiple tools if tasks are closely related.\n\n### Roleplay Mode\n\n- In **Roleplay Mode**, you continue the roleplay in natural language, adhering to the \'Role-playing Guidelines\'.\n- You **MUST NOT** output JSON in Roleplay Mode.\n- If there is no good use of the tools, you **MUST NOT** call the tool, but only Roleplay Mode instead.\n\n### Tool Invocation Decision-Making\n\n- Tools must closely related to each other.\n- Consider the impact: Will using these tools significantly contribute to the development of the story, the understanding of the characters, or the richness of the world in a way that cannot be achieved through natural language alone?\n- Assess relevance: Are the tools directly relevant to the current situation and the immediate needs of the roleplay? Avoid using tools for tasks that are extraneous or could be handled within the narrative.\n- Think about verisimilitude: Does using the tools in this context feel natural and believable within the world of the roleplay? Would a character in this situation realistically utilize such tools (if the characters had access to tools)?\n- Avoid Redundancy: Do not attempt to use tools if the desired outcome could be achieved through simple narration or dialogue.\n- Do not use Tool to perform redundant action\n\n### Tool Invocation Format\n\n- If and **ONLY IF** you are in **Tool Invocation Mode**:\n- Your **ENTIRE** response **MUST** be a valid JSON array (list) of objects, where each object represents a single tool invocation. Each object must have the following structure:\n\n```json\n[\n{\n  "tool_name": "name_of_tool_1",\n  "parameters": {\n    "param1": "value1",\n    "param2": "value2",\n    ...\n  }\n},\n{\n  "tool_name": "name_of_tool_2",\n  "parameters": {\n    "paramA": "valueA",\n    "paramB": "valueB",\n    ...\n    }\n},\n...\n]\n```\n\n- Replace `"name_of_tool_X"` with the **EXACT** name of the tool you wish to use (as defined in the \'Available Tools\' section).\n- The `"parameters"` object for each tool should contain **ONLY** the parameters required by that tool, and their corresponding values.\n- Adhere **STRICTLY** to the schema defined for each tool when constructing the `"parameters"` object. **VALIDATE YOUR JSON** before including it in your response.\n- Ensure the JSON is parsable without errors.\n- You should only use multiple tools if tasks are closely related\n\n### Available Tools\n\nThese tools are available for your use. Study their schemas carefully:\n\n```json\n'.concat(n.tools,"\n```\n\n\x3c!-- End of Tool Usage Guidelines --\x3e\n\nContinue the roleplay. Remember to choose **either Tool Invocation Mode or Roleplay Mode** for each response, and **NEVER** combine them."),X.setExtensionPrompt(Q,o,1,0);case 12:case"end":return e.stop()}}),e)}))),ee.apply(this,arguments)}!function(){var e=SillyTavern.getContext();e.extensionSettings.mcp=e.extensionSettings.mcp||{};for(var t=!1,r=0,n=Object.keys(W);r<n.length;r++){var o=n[r];void 0===e.extensionSettings.mcp[o]&&(e.extensionSettings.mcp[o]=W[o],t=!0)}t&&e.saveSettingsDebounced()}(),function(){K.apply(this,arguments)}(),function(){z.apply(this,arguments)}(),X.eventSource.on(w.ONLINE_STATUS_CHANGED,B(Y().mark((function e(){return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Z();case 2:case"end":return e.stop()}}),e)})))),X.eventSource.on(w.CHAT_CHANGED,B(Y().mark((function e(){return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Z();case 2:case"end":return e.stop()}}),e)})))),X.eventSource.on(w.MESSAGE_RECEIVED,function(){var e=B(Y().mark((function e(t){var r,n,o,a,i,c;return Y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=SillyTavern.getContext(),n=r.chat[Number(t)]){e.next=4;break}return e.abrupt("return");case 4:if(o=n.mes.match(/```(?:\w+)?\s*([\s\S]*?)```/)){e.next=7;break}return e.abrupt("return");case 7:if(e.prev=7,null!=(i=JSON.parse(o[1]))&&i.length){e.next=11;break}return e.abrupt("return");case 11:return e.next=13,r.deleteLastMessage();case 13:return e.next=15,r.invokeFunctionTools({responseContent:{parts:i.map((function(e){return{functionCall:{name:e.tool_name,args:e.parameters}}}))}});case 15:return c=e.sent,e.next=18,r.saveFunctionToolInvocations(c.invocations);case 18:r.chat[Number(t)].is_system=!1,null===(a=r.chat[Number(t)].extra)||void 0===a||delete a.tool_invocations,M(),e.next=25;break;case 23:e.prev=23,e.t0=e.catch(7);case 25:case"end":return e.stop()}}),e,null,[[7,23]])})));return function(t){return e.apply(this,arguments)}}());